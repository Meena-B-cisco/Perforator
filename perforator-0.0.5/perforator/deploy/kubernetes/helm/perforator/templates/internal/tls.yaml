{{- $ca := genCA (printf "%s-storage-service-ca" (include "perforator.fullname" .)) 3650 }}
{{- if and .Values.storage.enabled .Values.storage.tls.enabled (or .Values.storage.tls.autoGenerated .Values.storageAgentTLS.autoGenerated) (not (coalesce .Values.storage.tls.existingSecret .Values.storageAgentTLS.storage.existingSecret)) -}}
{{- $hostname := .Values.storage.hostname }}
{{- if $hostname }}
{{- if contains ":" $hostname }}
  {{- $hostname = index (regexSplit ":" $hostname -1) 0 }}
{{- end }}
{{- else }}
{{- $hostname = (printf "%s-storage-service" (include "perforator.fullname" .)) }}
{{- end }}
{{- $storageCert := genSignedCert $hostname nil (list $hostname) 3650 $ca }}
{{- $storageSecretName := printf "%s-storage-crt" (include "perforator.fullname" .) }}
apiVersion: v1
data:
  tls.crt: {{ include "perforator.secrets.lookup" (dict "nameSpace" .Release.Namespace "secretName" $storageSecretName "key" "tls.crt" "defaultVal" $storageCert.Cert) }}
  tls.key: {{ include "perforator.secrets.lookup" (dict "nameSpace" .Release.Namespace "secretName" $storageSecretName "key" "tls.key" "defaultVal" $storageCert.Key) }}
  ca.crt:  {{ include "perforator.secrets.lookup" (dict "nameSpace" .Release.Namespace "secretName" $storageSecretName "key" "ca.crt" "defaultVal" $ca.Cert) }}
kind: Secret
metadata:
  name: {{ $storageSecretName }}
  namespace: {{ .Release.Namespace }}
type: kubernetes.io/tls
---
{{- end }}
{{- if and .Values.agent.tls.enabled .Values.agent.tls.autoGenerated (not .Values.agent.tls.existingSecret) }}
{{- $agentHostname := (printf "%s-agent-service" (include "perforator.fullname" .)) }}
{{- $agentCert := genSignedCert $agentHostname nil (list $agentHostname) 3650 $ca }}
{{- $agentSecretName := printf "%s-agent-crt" (include "perforator.fullname" .) }}
apiVersion: v1
data:
  tls.crt: {{ include "perforator.secrets.lookup" (dict "nameSpace" .Release.Namespace "secretName" $agentSecretName "key" "tls.crt" "defaultVal" $agentCert.Cert) }}
  tls.key: {{ include "perforator.secrets.lookup" (dict "nameSpace" .Release.Namespace "secretName" $agentSecretName "key" "tls.key" "defaultVal" $agentCert.Key) }}
  ca.crt:  {{ include "perforator.secrets.lookup" (dict "nameSpace" .Release.Namespace "secretName" $agentSecretName "key" "ca.crt" "defaultVal" $ca.Cert) }}
kind: Secret
metadata:
  name: {{ $agentSecretName }}
  namespace: {{ .Release.Namespace }}
type: kubernetes.io/tls
{{- end }}